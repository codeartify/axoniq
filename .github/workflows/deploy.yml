name: FitnessLab CI/CD

on:
  push:
    branches: ['**']
    paths:
      - 'backend/**'
      - 'frontend/**'
      - '.github/workflows/deploy.yml'
  workflow_dispatch:

jobs:
  test-backend:
    runs-on: ubuntu-latest

    services:
      postgres:
        image: postgres:18
        env:
          POSTGRES_USER: test
          POSTGRES_PASSWORD: test
          POSTGRES_DB: fitnesslab
        ports:
          - 5432:5432
        options: >-
          --health-cmd="pg_isready -U test -d fitnesslab"
          --health-interval=5s
          --health-timeout=5s
          --health-retries=10

    steps:
      - name: Checkout repository
        uses: actions/checkout@v4

      - name: Set up JDK 21
        uses: actions/setup-java@v4
        with:
          java-version: '21'
          distribution: 'temurin'
          cache: 'maven'

      - name: Wait for Postgres
        run: |
          for i in {1..30}; do
            nc -z 127.0.0.1 5432 && echo "Postgres is up!" && exit 0
            echo "Waiting for Postgres..."
            sleep 2
          done
          echo "Postgres did not become ready in time" >&2
          exit 1

      - name: Build and test backend
        env:
          SPRING_DATASOURCE_URL: jdbc:postgresql://127.0.0.1:5432/fitnesslab
          SPRING_DATASOURCE_USERNAME: test
          SPRING_DATASOURCE_PASSWORD: test
        run: mvn clean test
        working-directory: backend

  test-frontend:
    runs-on: ubuntu-latest

    steps:
      - name: Checkout repository
        uses: actions/checkout@v4

      - name: Set up Node.js
        uses: actions/setup-node@v4
        with:
          node-version: '22.x'
          cache: 'npm'
          cache-dependency-path: frontend/fitnesslab/package-lock.json

      - name: Install dependencies
        run: npm install --legacy-peer-deps
        working-directory: frontend/fitnesslab

      - name: Generate API client
        run: npm run generate-api
        working-directory: frontend/fitnesslab

      - name: Build frontend
        run: npm run build
        working-directory: frontend/fitnesslab

      # Skip tests for now - requires proper test configuration
      # - name: Test frontend
      #   run: npm run test
      #   working-directory: frontend/fitnesslab

  build-and-push:
    needs: [test-backend, test-frontend]
    runs-on: ubuntu-latest
    if: github.ref == 'refs/heads/main'

    steps:
      - name: Checkout repository
        uses: actions/checkout@v4

      - name: Login to DockerHub
        uses: docker/login-action@v3
        with:
          username: ${{ secrets.DOCKERHUB_USERNAME }}
          password: ${{ secrets.DOCKERHUB_TOKEN }}

      - name: Build and push backend image
        run: |
          docker build -t ${{ secrets.DOCKER_BACKEND_IMAGE_NAME }}:latest --push .
        working-directory: backend

      - name: Build and push frontend image
        run: |
          docker build -f frontend/fitnesslab/Dockerfile -t ${{ secrets.DOCKER_FRONTEND_IMAGE_NAME }}:latest --push .

  deploy:
    needs: build-and-push
    runs-on: ubuntu-latest
    if: github.ref == 'refs/heads/main'

    steps:
      - name: Checkout repository
        uses: actions/checkout@v4

      - name: Install sshpass
        run: sudo apt-get update && sudo apt-get install -y sshpass

      - name: Copy docker-compose files to server
        run: |
          sshpass -p "${{ secrets.SSH_PASS }}" scp -o StrictHostKeyChecking=no -P ${{ secrets.SSH_PORT }} \
            docker-compose.backend.yml docker-compose.frontend.yml \
            ${{ secrets.SSH_USER }}@${{ secrets.SSH_HOST }}:${{ secrets.DEPLOY_PATH }}/

      - name: Deploy backend with docker-compose
        run: |
          sshpass -p "${{ secrets.SSH_PASS }}" ssh -o StrictHostKeyChecking=no -p ${{ secrets.SSH_PORT }} \
            ${{ secrets.SSH_USER }}@${{ secrets.SSH_HOST }} << 'EOF'
              cd ${{ secrets.DEPLOY_PATH }}

              # Export environment variables for docker-compose
              export DOCKER_BACKEND_IMAGE_NAME=${{ secrets.DOCKER_BACKEND_IMAGE_NAME }}:latest
              export POSTGRES_USER=${{ secrets.POSTGRES_USER }}
              export POSTGRES_PASSWORD=${{ secrets.POSTGRES_PASSWORD }}
              export POSTGRES_DB=${{ secrets.POSTGRES_DB }}
              export POSTGRES_PORT=${{ secrets.POSTGRES_PORT }}
              export BACKEND_PORT=${{ secrets.BACKEND_PORT }}
              export MAIL_PASSWORD=${{ secrets.MAIL_PASSWORD }}
              export MAILHOG_SMTP_PORT=${{ secrets.MAILHOG_SMTP_PORT }}
              export MAILHOG_WEB_PORT=${{ secrets.MAILHOG_WEB_PORT }}

              # Pull latest images and deploy backend stack
              ${{ secrets.DOCKER_PATH_ON_SERVER }}docker-compose -f docker-compose.backend.yml pull
              ${{ secrets.DOCKER_PATH_ON_SERVER }}docker-compose -f docker-compose.backend.yml up -d

              # Clean up dangling images
              ${{ secrets.DOCKER_PATH_ON_SERVER }}docker image prune -f
          EOF

      - name: Deploy frontend with docker-compose
        run: |
          sshpass -p "${{ secrets.SSH_PASS }}" ssh -o StrictHostKeyChecking=no -p ${{ secrets.SSH_PORT }} \
            ${{ secrets.SSH_USER }}@${{ secrets.SSH_HOST }} << 'EOF'
              cd ${{ secrets.DEPLOY_PATH }}

              # Export environment variables for docker-compose
              export DOCKER_FRONTEND_IMAGE_NAME=${{ secrets.DOCKER_FRONTEND_IMAGE_NAME }}:latest
              export FRONTEND_PORT=${{ secrets.FRONTEND_PORT }}
              export API_URL=${{ secrets.API_URL }}
              export AUTH_ISSUER=${{ secrets.AUTH_ISSUER }}
              export AUTH_CLIENT_ID=${{ secrets.AUTH_CLIENT_ID }}

              # Pull latest images and deploy frontend
              ${{ secrets.DOCKER_PATH_ON_SERVER }}docker-compose -f docker-compose.frontend.yml pull
              ${{ secrets.DOCKER_PATH_ON_SERVER }}docker-compose -f docker-compose.frontend.yml up -d

              # Clean up dangling images
              ${{ secrets.DOCKER_PATH_ON_SERVER }}docker image prune -f
          EOF
