<div class="p-5 max-w-7xl mx-auto">
  <h1 class="text-3xl font-bold text-gray-800 mb-5">{{ 'invoice.list.title' | translate }}</h1>

  <div class="mb-5">
    <input
      type="text"
      [placeholder]="'invoice.list.searchPlaceholder' | translate"
      [ngModel]="searchTerm()"
      (ngModelChange)="searchTerm.set($event)"
      class="w-full px-3 py-2 text-base border border-gray-300 rounded focus:outline-none focus:ring-2 focus:ring-blue-500"
    />
  </div>

  <div class="overflow-x-auto bg-white shadow-md rounded-lg">
    <table class="w-full border-collapse">
      <thead class="bg-gray-100">
      <tr>
        <th (click)="sortBy('invoiceId')"
            class="px-3 py-3 text-left border-b-2 border-gray-300 cursor-pointer select-none font-semibold hover:bg-gray-200 transition-colors">
          {{ 'invoice.table.invoiceId' | translate }} {{ getSortIcon('invoiceId') }}
        </th>
        <th (click)="sortBy('customerName')"
            class="px-3 py-3 text-left border-b-2 border-gray-300 cursor-pointer select-none font-semibold hover:bg-gray-200 transition-colors">
          {{ 'invoice.table.customerName' | translate }} {{ getSortIcon('customerName') }}
        </th>
        <th (click)="sortBy('amount')"
            class="px-3 py-3 text-left border-b-2 border-gray-300 cursor-pointer select-none font-semibold hover:bg-gray-200 transition-colors">
          {{ 'invoice.table.amount' | translate }} {{ getSortIcon('amount') }}
        </th>
        <th (click)="sortBy('dueDate')"
            class="px-3 py-3 text-left border-b-2 border-gray-300 cursor-pointer select-none font-semibold hover:bg-gray-200 transition-colors">
          {{ 'invoice.table.dueDate' | translate }} {{ getSortIcon('dueDate') }}
        </th>
        <th (click)="sortBy('status')"
            class="px-3 py-3 text-left border-b-2 border-gray-300 cursor-pointer select-none font-semibold hover:bg-gray-200 transition-colors">
          {{ 'invoice.table.status' | translate }} {{ getSortIcon('status') }}
        </th>
        <th
          class="px-3 py-3 text-left border-b-2 border-gray-300 font-semibold">{{ 'invoice.table.installment' | translate }}
        </th>
        <th class="px-3 py-3 text-left border-b-2 border-gray-300 font-semibold">{{ 'common.actions' | translate }}</th>
      </tr>
      </thead>
      <tbody>
        @for (invoice of filteredAndSortedInvoices(); track invoice.invoiceId) {
          <tr class="hover:bg-gray-50 transition-colors">
            <td class="px-3 py-3 border-b border-gray-200">{{ invoice.invoiceId.substring(0, 8) }}...</td>
            <td class="px-3 py-3 border-b border-gray-200">
              <a (click)="viewCustomer(invoice.customerId)" (keydown.enter)="viewCustomer(invoice.customerId)"
                 tabindex="0" role="button" class="text-blue-600 cursor-pointer underline hover:text-blue-800">
                {{ invoice.customerName }}
              </a>
            </td>
            <td class="px-3 py-3 border-b border-gray-200">CHF {{ invoice.amount | number:'1.2-2' }}</td>
            <td class="px-3 py-3 border-b border-gray-200">{{ invoice.dueDate | date:'shortDate' }}</td>
            <td class="px-3 py-3 border-b border-gray-200">
              @if (invoice.status === 'OPEN') {
                <span class="px-2 py-1 rounded text-xs font-semibold uppercase bg-blue-100 text-blue-800">
                  {{ invoice.status }}
                </span>
              }
              @if (invoice.status === 'PAID') {
                <span class="px-2 py-1 rounded text-xs font-semibold uppercase bg-green-100 text-green-800">
                  {{ invoice.status }}
                </span>
              }
              @if (invoice.status === 'OVERDUE') {
                <span class="px-2 py-1 rounded text-xs font-semibold uppercase bg-orange-100 text-orange-800">
                  {{ invoice.status }}
                </span>
              }
              @if (invoice.status === 'CANCELLED') {
                <span class="px-2 py-1 rounded text-xs font-semibold uppercase bg-red-100 text-red-800">
                  {{ invoice.status }}
                </span>
              }
            </td>
            <td class="px-3 py-3 border-b border-gray-200">
              @if (invoice.isInstallment) {
                <span>{{ 'invoice.installment.yes' | translate: {number: invoice.installmentNumber} }}</span>
              }
              @if (!invoice.isInstallment) {
                <span>{{ 'invoice.installment.no' | translate }}</span>
              }
            </td>
            <td class="px-3 py-3 border-b border-gray-200 whitespace-nowrap">
              @if (invoice.status === 'OPEN' || invoice.status === 'OVERDUE') {
                <button
                  (click)="markAsPaid(invoice.invoiceId)"
                  class="px-3 py-1.5 bg-green-500 text-white rounded border-none cursor-pointer text-sm mr-2 hover:bg-green-600 transition-colors"
                >
                  {{ 'button.markPaid' | translate }}
                </button>
              }
              @if (invoice.status === 'OPEN') {
                <button
                  (click)="markAsOverdue(invoice.invoiceId)"
                  class="px-3 py-1.5 bg-orange-500 text-white rounded border-none cursor-pointer text-sm mr-2 hover:bg-orange-600 transition-colors"
                >
                  {{ 'button.markOverdue' | translate }}
                </button>
              }
              @if (invoice.status !== 'PAID' && invoice.status !== 'CANCELLED') {
                <button
                  (click)="openCancelModal(invoice.invoiceId)"
                  class="px-3 py-1.5 bg-red-500 text-white rounded border-none cursor-pointer text-sm mr-2 hover:bg-red-600 transition-colors"
                >
                  {{ 'common.cancel' | translate }}
                </button>
              }
            </td>
          </tr>
        }
      </tbody>
    </table>
  </div>

  @if (filteredAndSortedInvoices().length === 0) {
    <div class="text-center py-10 text-gray-500 text-lg">
      {{ 'invoice.list.noInvoicesFound' | translate }}
    </div>
  }
</div>

<!-- Cancel Modal -->
@if (showCancelModal()) {
  <div class="fixed inset-0 bg-black bg-opacity-50 flex justify-center items-center z-50" (click)="closeCancelModal()"
       (keydown.escape)="closeCancelModal()" tabindex="0" role="dialog" aria-modal="true">
    <div class="bg-white p-6 rounded-lg max-w-lg w-11/12 shadow-xl" (click)="$event.stopPropagation()"
         (keydown)="$event.stopPropagation()" tabindex="-1">
      <h2 class="mt-0 mb-4 text-xl font-semibold text-gray-800">{{ 'invoice.list.cancelModal.title' | translate }}</h2>
      <p class="mb-4">{{ 'invoice.list.cancelModal.reasonPrompt' | translate }}</p>
      <textarea
        [(ngModel)]="cancelReason"
        class="w-full px-3 py-2 border border-gray-300 rounded text-sm resize-y mb-4 focus:outline-none focus:ring-2 focus:ring-blue-500"
        [placeholder]="'invoice.list.cancelModal.reasonPlaceholder' | translate"
        rows="4"
      ></textarea>
      <div class="flex justify-end gap-2">
        <button (click)="closeCancelModal()"
                class="px-3 py-1.5 bg-gray-500 text-white rounded border-none cursor-pointer text-sm hover:bg-gray-600 transition-colors">
          {{ 'common.close' | translate }}
        </button>
        <button (click)="confirmCancel()"
                class="px-3 py-1.5 bg-red-500 text-white rounded border-none cursor-pointer text-sm hover:bg-red-600 transition-colors">
          {{ 'button.confirmCancel' | translate }}
        </button>
      </div>
    </div>
  </div>
}
